<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <title>Timeline Manual Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- βοηθά τα σχετικά paths όταν ανοίγεις με file:// -->
  <base href="./" />
  <style>
    :root{
      --tl-font: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --tl-primary-color:#4f7fff;
      --tl-background-color:#0b1020;
      --tl-text-color:#e6eefc;
      --tl-card-radius:14px;
    }
    body{margin:0;background:#060a16;color:#e6eefc;font-family:var(--tl-font)}
    .row{display:flex;gap:16px;padding:16px;flex-wrap:wrap}
    .col{flex:1 1 600px;min-width:360px;background:#0b1020;border:1px solid #1b2240;border-radius:12px;padding:12px}
    h2{margin:6px 0 12px 6px;font-size:15px;opacity:.85}
    #controls{position:sticky;top:0;background:#0b1020;padding:12px;z-index:999;border-bottom:1px solid #1b2240}
    button{background:#1a2446;color:#e6eefc;border:1px solid #2b3867;border-radius:8px;padding:8px 10px;cursor:pointer}
    button[disabled]{opacity:.4;cursor:default}
    .pad{padding:8px}
    .pane{height:420px;border-radius:10px;overflow:hidden;background:#0e1426}
  </style>
</head>
<body>
  <div id="controls">
    <button id="loadSmall">Load SMALL</button>
    <button id="loadMixed">Load MIXED</button>
    <button id="loadDense">Load DENSE</button>
    <span class="pad"></span>
    <button id="modeTime">Time mode</button>
    <button id="modePoint">Point mode</button>
  </div>

  <div class="row">
    <div class="col">
      <h2>SliderRenderer</h2>
      <div id="slider" class="pane"></div>
    </div>
    <div class="col">
      <h2>VerticalRenderer</h2>
      <div id="vertical" class="pane"></div>
    </div>
  </div>

  <div class="row">
    <div class="col" style="flex:1 1 100%">
      <h2>GridRenderer</h2>
      <div id="grid" class="pane" style="height:auto;max-height:70vh;overflow:auto"></div>
    </div>
  </div>

  <script type="module">
    import { SliderRenderer }   from "../src/renderers/SliderRenderer";
    import { VerticalRenderer } from "../src/renderers/VerticalRenderer";
    import { GridRenderer }     from "../src/renderers/GridRenderer";
    import { fixtures }         from "../tests/fixtures";

    // -----------------------------
    // BUSINESS LOGIC (paths & media)
    // -----------------------------

    const ASSETS_BASE_CANDIDATES = [
      "./examples/assets/",
      "../examples/assets/",
      "./assets/",
    ];

    function pickAssetsBase() {
      for (const b of ASSETS_BASE_CANDIDATES) {

        return b;
      }
      return "./";
    }

    const ASSETS_BASE = pickAssetsBase();

    function normalizeSrc(src) {
      if (!src) return src;

      // ήδη URL/data
      if (/^(https?:|file:|data:)/i.test(src)) return src;

      // Windows απόλυτο: C:\... ή D:\...
      if (/^[A-Za-z]:\\/.test(src)) {
        const forward = src.replace(/\\/g, "/");
        // προσπαθούμε να αναγνωρίσουμε "/examples/assets/" και να κάνουμε σχετικό path
        const m = forward.match(/\/examples\/assets\/(.+)$/i) || forward.match(/\/assets\/(.+)$/i);
        if (m) {
          return ASSETS_BASE + m[1];
        }
        return "file:///" + forward;
      }

      // Unix-like absolute path: /Users/.../assets/logo.png
      if (src.startsWith("/")) {
        const m = src.match(/\/examples\/assets\/(.+)$/i) || src.match(/\/assets\/(.+)$/i);
        if (m) {
          return ASSETS_BASE + m[1];
        }
        // αφήνουμε ως έχει (Firefox file://)
        return src;
      }

      // Σχετικό μονοπάτι (το κρατάμε)
      return src;
    }

    /** Κάνει deep clone timeline και νορμαλάρισμα όλων των media paths */
    function normalizeTimelineMedia(timeline) {
      const cloned = {
        ...timeline,
        items: timeline.items.map(it => {
          const item = { ...it };
          if (item.label) {
            const k = item.label.kind;
            if (k === "image") {
              item.label = {
                ...item.label,
                src: normalizeSrc(item.label.src),
              };
            } else if (k === "video") {
              item.label = {
                ...item.label,
                src: normalizeSrc(item.label.src),
                poster: item.label.poster ? normalizeSrc(item.label.poster) : undefined,
                // Firefox/Chromium autoplay heuristics
                autoplay: item.label.autoplay ?? true,
                muted: item.label.muted ?? true,
                loop: item.label.loop ?? true,
              };
            }
          }
          return item;
        }),
      };
      return cloned;
    }

    /** Τυλίγει ένα fixture { name, timeline } και επιστρέφει νέο αντικείμενο με normalized timeline */
    function normalizedFixture(fix) {
      return {
        name: fix.name,
        timeline: normalizeTimelineMedia(fix.timeline),
      };
    }

    // -----------------------------
    // App state & rendering
    // -----------------------------
    let current = normalizedFixture(fixtures.mixed); // ξεκινάμε με mixed normalized
    let axisStrategy = "time";

    const sliderEl   = document.getElementById("slider");
    const verticalEl = document.getElementById("vertical");
    const gridEl     = document.getElementById("grid");

    function renderAll() {
      const base = {
        axisStrategy,
        minLabelGap: 60,
        labelYOffset: -18,
        cardWidth: 160,
        cardHeight: 200,
        hideOverlappingLabels: true,
        zoom: { minScale: 1, maxScale: 50 },
        showTooltip: true,
        canvasBackground: { kind: "color", value: "var(--tl-background-color)" },
        onItemClick: (item) => console.log("CLICK", item.title),
        onItemHover: (item) => console.log("HOVER", item.title),
      };

      sliderEl.innerHTML = "";
      verticalEl.innerHTML = "";
      gridEl.innerHTML = "";

      SliderRenderer.render(current.timeline, sliderEl, {
        ...base,
        timeTickEveryYears: 2,
        pointTickStride: 2,
      });

      VerticalRenderer.render(current.timeline, verticalEl, {
        ...base,
        baselineX: 220,
      });

      GridRenderer.render(current.timeline, gridEl, { ...base });
    }

    // -----------------------------
    // Controls
    // -----------------------------
    document.getElementById("loadSmall").onclick  = () => { current = normalizedFixture(fixtures.small);  renderAll(); };
    document.getElementById("loadMixed").onclick  = () => { current = normalizedFixture(fixtures.mixed);  renderAll(); };
    document.getElementById("loadDense").onclick  = () => { current = normalizedFixture(fixtures.dense);  renderAll(); };
    document.getElementById("modeTime").onclick   = () => { axisStrategy = "time";  renderAll(); };
    document.getElementById("modePoint").onclick  = () => { axisStrategy = "point"; renderAll(); };

    renderAll();
  </script>
</body>
</html>
